When possible, please include bug numbers in the form "(bug #NNN)".

CVS - emk

IN PROGRESS: Vastly improved web browser integration, including the ability
to embed Internet Explorer using wxIE.

  * Added BrowserElement class to represent all web-browser-like elements.
    This includes foward/back/stop and set of standard events.
  * Added BrowserElementWx class to wrap the built-in wxHtmlWindow class.
    This isn't very good yet.
  * Added BrowserElementIE class to wrap the wxIEHtmlWin class.
  * Support for vetoing events.
  * New event types for EventDispatcher: browser-navigate,
    browser-page-changed, status-text-changed, progress-changed.
  * Added support for passing floating-point numbers to TCallbacks.

  * Added a MEASURE-PICTURE command.
  * Added an OFFSET-RECT command.
  * Modified PaintStage to only repaint the modified parts of the screen.
    This makes REFRESH slightly less likely to overdraw Widgets on the
    stage, but it does not fix the problem entirely.
  * Major enhancements to wxBrowserElementIE.
  * Various bugfixes to wxIE library.
  * More new event types for EventDispatcher: update-ui, browser-title-changed.
  * Added a function to convert DirtyLists to wxRegions.

0.0.13 - 6 Jan 2004 - emk

Basic drag & drop can now be implemented in Scheme.

  * Added support for (SET! (PROP elem name) value) in Scheme.  To support
    this on your templates, you need to implement an
    (ON PROP-CHANGE (name value prev veto) ...) handler.  Be sure to
    CALL-NEXT-HANDLER for properties you don't know about!  This API will
    probably change.
  * SET-ELEMENT-CURSOR! -> (SET! (PROP elem CURSOR) new-value)
  * Made several zone properties setable at runtime.
  * Overlays can now be moved.
  * Overlays no longer need to invalidate themselves when
    deleted--DrawingArea handles this internally.
  * Fixed some text-entry-related bugs.

0.0.12 - 5 Jan 2004 - emk

Graphics-related bug fixes:

  * Fixed bug where PNG's with 1-bit "mask" transparency were accidentally
    made transparent in too many places on 16-bit displays.
  * Fixed bug where opaque overlays with width N (where N*3 is odd) were
    reporting incorrect bmWidthBytes values under Win2K and causing raw
    access to look funny.

0.0.11 - 30 Dec 2003 - emk

TRANSPARENT OVERLAYS!  Added support for alpha-composited layers.  This
engine will require script updates:

  * SET-ZONE-CURSOR! has been renamed to SET-ELEMENT-CURSOR!.
  * RECT objects now (more) consistently exclude their right and bottom
    edges.  This may cause off-by-one errors in existing drawing code.
  * COLOR now represents opaque alpha values as 255 and transparent values
    as 0.  This is the opposite of the previous behavior.

Changes to Scheme Runtime:

  * Added :OVERLAY? and :ALPHA? to ZONE.  These allow you to create a
    rectangular zone with an associated drawing context (and optionally an
    alpha channel).  If :OVERLAY? is true, the zone must be rectangular.
  * Added (WITH-DRAWING-CONTEXT ZONE BODY...), which allows you to change
    the current drawing context.  Do not call IDLE within this form.
  * Added (DRAWING-CONTEXT-REXT), which returns the bounding rectangle
    for the current drawing context.
  * Added (COLOR-AT POINT), which returns the color at POINT in the
    current drawing context.
  * Fixed output routines to know about POINT, RECT and COLOR objects.
  * Support for storing POINT, RECT and COLOR objects in engine variables,
    including DEFINE/P.
  * Support for comparing POINT, RECT and COLOR objects with EQUALS?.

Changes to Tamale:

  * Added an Overlay class.  This is basically a square zone with its
    own (possibly transparent) DrawingArea and special hit-testing logic.
  * Switched from 0 opaque to 255 opaque, for performance and consistency
    with windows.
  * Support for TPoint, TRect, GraphicsTools::Color in engine variables.
  * TRect <-> wxRect conversion functions now reliably exclude right and
    bottom edges.
  * Added CompositeInto functions to Element and DrawingArea, for use with
    alpha-compositing.
  * DrawingAreas may now have alpha-channels.
  * Added alpha-channel support to DrawingArea::Clear.
  * Modified optimized versions of FillBox and DrawPixMap to use a
    templated transfer function, and added a transfer function for using
    them with DrawingAreas with alpha channels.
  * Fixed many bugs with arguments to DrawingArea::InvalidateRect.
  * Added support for retrieving pixel values.
  * Added support for pushing and poping drawing contexts.
  * Implemented a much-more-sophisticated list of dirty regions for use
    with the compositing.
  * Idling not allowed when a drawing context is pushed.
  * Replaced our single offscreen buffer with a compositing pixmap and
    and a background pixmap.
  * Invalidate an element's location when deleting it.

Changes to wxWindows:

  * Exported AlphaBlend from the MSW wxDC class, so we can do alpha blends
    between arbitrary DCs.
  * Removed wxBitmap::UngetRawData pre-multiplication code--there wasn't
    any matching code in wxBitmap::GetRawData, and many raw algorithms
    are much more efficient on pre-multiplied data.

0.0.10 - 19 Dec 2003 - emk

Lots of work to eliminate all Scheme memory allocation ("consing") while
idling.  This should fix video performance problems.

  * Added a cache of Scheme "buckets" (variable storage locations) so
    we don't have to allocate memory every time C++ needs to find something
    in the Scheme runtime.
  * Tweaked the idle interface so we don't need to call 'apply'.

Other changes:

  * Put in some stubs for allowing different font-sizes in edit boxes.

0.0.9 - 11 Dec 2003 - emk

  * Limited maximum chirp rate for new Geiger synth.
  * Added a ':multiline?' parameter to edit-box.  See 5Ltest_wx for samples.

0.0.8 - 17 Nov 2003 - emk, brian

  * Added SET-MEDIA-BASE-URL! function.  Pass it either a QuickTime-
    compatible URL or #f (to use the hard drive).
  * Major refactorings of Scheme runtime to help make it testable.
  * Fixed bug where api.ss didn't get recompiled when kernel.ss changed.
  * Split StageFrame out of Stage.
  * Split DrawingArea out of Stage.
  * Reduced coupling between nodes.ss and kernel.ss.
  * Made element deletion the responsibility of Scheme.
  * More work on Geiger audio synth.
  * Turned on QuickTime safe mode to avoid nasty performance problems
    with Boehm.
  * Merged TQTMovie changes from FiveL 3.4.

0.0.7 - 2 July 2003 - emk, brian

  * All known audio artifacts in Geiger synth and looping Vorbis
    playback have now been fixed.
  * PARAM renamed to PROP.
  * Major restructuring of template property binding.
  * EVENT-CHARACTER now returns a character, not a string
  * PROP and SEND no longer need their name argument to be quoted
  * Support for screenshots: (SCREENSHOT) will write the current screen
    to a file in the Screenshots directory
  * ON handlers may now return a value
  * Scheme elements don't need to have corresponding C++ elements
  * More or less everything can have an idle handler now
  * Added a MOUSE-MOVED event.
  * New TestCase classes based on xUnit.  These run within the engine.
  * Lots of improvements in build performance.

0.0.6 - 4 June 2003 - emk, brian

Audio work by emk:

  * Mono Vorbis audio supported.
  * Per-channel volume supported.
  * Looping Vorbis audio.
  * Basic real-time Geiger synth implemented.  It still has issues.

Polygon work by brian:

  * Added support for polygons (POLYGON point ...).
  * Added support for polygonal zones (ZONE name poly callback). Rects
    still work: (ZONE name rect callback) will convert the rect to a
    polygon.
  * Added support for copying polygon definition strings to clipboard
    using crosshair control. 

0.0.5 - 30 May 2003 - emk

A very primitive audio layer, with Vorbis support.  I'm making a release so
the media folks have something to play with.

  * Integrated portaudio audio output library.
  * Integrated libivorbisdec (a.k.a. "Tremor") integerized Ogg Vorbis
    audio decoder.
  * Added new VorbisFile class for loading Ogg Vorbis streams (incomplete).
  * Added new AudioStream class for streaming audio output.
  * Added VorbisAudioStream and SineAudioStream classes.
  * Refactoed IMediaElement interface out of MovieElement.
  * Added AudioStreamElement class.
  * New functions: VORBIS-AUDIO and SINE-WAVE.  These are mostly for
    testing at this point.
  * We no longer drop Vorbis samples during playback (I hope!).

0.0.4 - 28 May 2003 - emk, brian

  * Changed CARD syntax to (CARD name () body ...).
  * Allowed GROUP and SEQUENCE to have initialization code:
    (GROUP name () body ...).
  * Can define templates for card groups, cards and elements.
  * Can create temporary elements using CREATE.  These get deleted
    when exiting the card.
  * Can access template parameters directly, or by using PARAM.
  * DRAW-BOX now honors alpha value of color argument.
  * Event handling system moved into kernel.ss and redesigned.
  * Callbacks are now re-entrant.
  * New events: MOUSE-DOWN, MOUSE-UP, MOUSE-ENTER, MOUSE-LEAVE.
  * New functions: MOUSE-GRAB, MOUSE-UNGRAB, MOUSE-GRABBED?.
  * ZONE, MOVIE, HTML and EDIT-BOX now use element templates
    internally.
  * Third-party code with vague or unknown licenses should
    be pulled from the tree.

0.0.3 - 9 May 2003 - emk, brian

  * When switching from 3D to 2D, blit the Quake display into our
    offscreen buffer to avoid an ugly "cut to black".
  * Renamed PAUSE and RESUME to MOVIE-PAUSE and MOVIE-RESUME.
  * Modified the (REFRESH ...) command to do something useful in the new
    engine.  However, since there's no way to mark the screen as having
    been repainted, this leads to duplicate painting.  Fixing this
    is fairly hard.
  * Fixed loading of alpha channels and alpha channel memory
    allocation bug.
  * Implemented crossfades.  Use (REFRESH :transition 'crossfade :ms 500).
  * Implemented built-in timing of transitions, to make different machines
    more consistent.
  * Implemented more transitions: wipeleft, wiperight, wipeup, wipedown,
    pushleft, pushright, pushup, pushdown, toblack, fromblack.
  * Reimplemented FADE and UNFADE commands using timed transitions.
  * When in cross-hair mode, right-clicking will copy the current point
    to the clipboard.  Shift-right-clicking will copy the previous and
    current points to the clipboard as a rectangle.
  * Added support for saving current offcreen buffer. Use
    SAVE-GRAPHICS and RESTORE-GRAPHICS. To save or restore a
    particular rectangle, use (SAVE-GRAPHICS :bounds (rect ...)) or
    (RESTORE-GRAPHICS :bounds (rect ...))
  * Very naive implementation of screen resizing--this has no sanity
    checks, no warnings, and probably dies a miserable death if
    multiple monitors are involved.  However, it does fix the bug
    where windows would not be properly centered in full-screen mode.

0.0.2 - 3 May 2003 - emk, brian

Now that we're producing real builds again, we're going to start keeping
this file up to do date.

What's happened since last update:

  * The engine was renamed to Tamale.
  * We added lots of new features.  It's beginning to resemble a real
    program.

New in this build:

  * Sequences, alpha channels, convenience features in the GUI,
    support for Swindle, pausing and resuming movies, etc.

0.0.? - emk

Primitive support for running Quake 2 from within wx5L.

  * Added primitives to show/hide widgets, and perform some other
    basic operations.
  * Replaced background wxPanel with wxWindow to 
  * Added Quake2Engine class.
  * Added support for Reload Script when Quake is running.
  * Added many primtives for interacting with Quake.
  * Added support for attaching Scheme callbacks to Quake commands.

3.5.11 - 19 Nov 2002 - emk

Regular 5L:

  * Wrote code to release script resources before retrying a failed
    script load.

wx5L:

  * Added wx/src/AppConfig.h, which can be used to enable and disable
    various GUI features on a per-platform basis.
  * Made the LocationBar class inherit from either wxComboBox or
    wxTextCtrl, depending on which is more likely to work on a given
    platform.

3.5.10 - 6 Nov 2002 - emk

wx5L:

Working on making wx5L portable.  The Windows wx5L build is slightly
broken; I'll fix it once the portable code is happy.

  * Added FIVEL_NO_MOVIES define to supress use of QuickTime in wx5L builds.
  * Refactored MovieWindow into two classes: MovieWindow, which does
    nothing, and MovieWindowQT which does all the work.  Refer to
    MovieWindowNative to get the right one on a given platform.
  * Wrote scripts to convert *.ico and *.bmp files to *.xpm files.
  * Added AppGraphics.h and AppGraphics.cpp, which import xpm files.
  * Checked in some other utility scripts, and updated 5L-stats.

Regular 5L:

Added type information to 5L variables, and replaced (var ...) with a more
powerful form of (define ...).  These changes should make Scheme more
pleasant for content authors.

  * TVariable now stores type information.
  * Added SetTyped primitive, and replaced VariableExists with
    VariableInitialized.
  * Added support for "symbol" arguments to primitives.  These correspond
    to Scheme symbols, and should eventually be used when a primitive
    argument refers to a variable name (or one a small, fixed set of strings).
  * Fixed bugs in TVariable's unsigned integer handling.
  * Removed TYPE argument from call-5l-prim, engine-var, etc.
  * Renamed DEFINE-PERSISTENT-VARIABLE to DEFINE/P.
  * Updated fake-engine.ss to mimic new engine, and fixed bug in tool.ss.

3.5.9 - 31 Oct 2002 - emk

  * New wxWindows front-end now officially added to the build tree.
    This is still massively incomplete, but it's on its way.
  * Lots of compilation flag tweaks, to get all the various Win32 projects
    on the same page re: threads, RTTI, exceptions, etc.
  * CryptTool removed as first step in preparing for open souce release.
    This will simplify our legal issues a bit.
  * Linux build fixes.
  * Fixed bug where MacOS X 5L always played the same video from the CD.
  * Converted all *.rsrc and *.PPob files to *.r files, and included
    instructions on converting them back and forth.  This will allow us
    to play a bit more nicely with CVS, and eliminate all but a few
    files with resource forks from our CVS repository.
  * Source tree re-organization:
    - Common/libs -> libs
    - Common/freetype2 -> libs/freetype2
    - Rename Common/Runtime/5L/*.ss to have lowercase names
    - Linux, Mac, Win32 build fixes

3.5.8 - 15 Oct 2002 - emk

Engine:

  * The Windows engine now reloads scripts in the same fashion as the
    Mac engine--if a load fails, you get a chance to retry it.
  * Log files get flushed after every line.
  * The LOG and SCHEMEIDLE primitives are no longer logged, to reduce
    clutter in Debug.log.
  * Fixed tons of bugs in places where the Windows engine assumed it
    had a TInterpreter object, but didn't (i.e., lots of "sInstance"
    assertions are gone).
  * Added support for measuring text without drawing it.
  * Added support for checking whether an engine variable is initialized.
  * Made sure LCursor initializes mForceShow.

Runtime:

  * Support for compiling *.ss files to *.zo files automatically
    (incomplete--it only handles modules loaded with REQUIRE right now).
  * Support for deferring code until the engine is in a safe place to
    run it.  This means that you can call VIDEO, INPUT, etc., from
    within a callback.
  * The syntax of 'for' loops has been simplified.
  * Explicit support for using stylesheets with the INPUT command.
  * Added 'card-exists?' predicate.
  * Fixed bug in 'member?'.
  * Added support for using (var ...) declarations within 'lambda', 'define'
    and 'let'.
  * Added support for initializing engine variables.
  * Made call-5L-prim handle return values of non-string types gracefully.
  * Fixed bugs causing centered and left-aligned text to be measured
    incorrectly.
  * Added a hook system based on Emacs.

3.5.7 - 9 Oct 2002 - emk

Engines built from this code will require script changes.

  * Scheme: Changed 'for-each-item' to 'foreach', and added 'for'.
  * Added extract-docs.pl, which generates HTML manuals.
  * Added many new test cases for the new 5L language.
  * Fixed minor bugs in CryptStream*.*, as discovered by valgrind.
  * All primitives which used to take palette indices now take RGB colors.
  * Old 5L: Added DEFPALETTE command for declaring palettes without
    BMP files.  This provides backwards compatibility for old code.
  * Removed Windows cursor-clipping code because it was occassionally
    immobilizing the cursor completely.

3.5.6 - 3 Oct 2002 - emk

  * Refactored CHeader in the same fashion as Header and TStyleSheet,
    which should allow headers (and therefore input) to be used from
    Scheme.  This may also fix a redoscript problem in old5l.
  * Merged "cursor during video" fix from 3.4.2.
  * Built new Windows engines with the MzScheme 202 code.  You'll
    need to get the newest version of the appropriate libmzsch and
    libmzgc DLLs.

3.5.5 - 2 Oct 2002 - emk

Preliminary MzScheme support for Macintosh engine.  DO NOT BUILD THE
NON-CARBON POWERPC BUILD!  WHEN RUN UNDER OS X'S OS 9 EMULATOR, IT WILL
CORRUPT YOUR OS 9 SYSTEM FILE.

For legal reasons, this Macintosh engine SHOULD NOT BE DISTRIBUTED outside
of IML until we do our open source release.  It's statically-linked against
the LGPL'd MzSchemeLib, which would require us to jump through some
annoying hoops if we wanted to ship proprietary binaries.

User-visible changes:

  * This engine supports both legacy 5L and Scheme.
  * No PowerPC build.
  * No more start scripts.  Move everything into your main script.
  * No more switching between scripts.
  * CD ejection and fades are gone, thanks to the fact this build is
    Carbon-only.

Engine changes:

  * Created CodeWarrior project for MzSchemeLib, to avoid the pay-per-view
    cage match between MPW StdCLib and Metrowerks Standard Library over
    who's going to link with what.
  * Fixed MzScheme's call to PBGetCatInfo to work under Carbon.
  * Added code to explicitly set Boehm GC stack base on the Macintosh.
    Boehm can't figure this out without help, and will crash on startup.
  * Namespace fixes to make things compile on the Mac.
  * Made a mess of the MzSchemeLib MPW build infrastructure trying to get
    things to work.  I'm checking in my hacked-up version because (1) it
    marginally works and (2) we might need it again someday.
  * Removed a number of unused files with licensing problems, and sorted
    the rest of the problematic files into categories.
  * Changed event-handling model to give the TInterpreterManager object
    control, instead of the traditional PowerPlant::LApplication::Run
    method.  This requires us to roll our own version of Run and do some
    tricky event handling in CMac5LApp::MacIdleProc.  But it also means the
    Mac engine now supports arbitrary interpreters.  This change has lots
    of consequences, most of them complicated--and it may affect stability.
  * CPlayerView is now more careful about checking whether a TInterpreter
    object actually exists before calling methods on it.
  * Renamed MakeNewIndex methods to ProcessTopLevelForm.
  * Moved all old5l-related files into Mac/Source/lang/old5l.
  * Moved interpreter-managing code into TMac5LInterpreter.{h,cpp}.
  * Moved file-related primitives into TMac5LPrimitives.cpp.
  * Shift-scripts are gone.
  * Ripped out support for switching scripts.
  * Reimplemented script reloading, exiting, etc., using the
    TInterpreterManager interface.
  * Lots of changes to the Macintosh project files.
  * Updated Windows interpreter to newest MzScheme release.
  * Fixed the Linux build.

Headers (and therefore text input) are only available to the old 5L
language.  This will change soon.

3.5.4 - 21 Aug 2002 - emk

Engine:

  * Moved many source files from Common to Common/lang/old5L, and from
    Win32/FiveL to Win32/FiveL/lang/old5l, including the index system, the
    parser and stream classes, the crypto classes and the file I/O classes.
  * Broke the dependencies between Header and TIndex, in a fashion similar
    to what I did for TStyleSheet in 3.5.1.  This means we can call
    INPUT from Scheme, which more-or-less completes the Scheme primitives.
  * Made sure that header and stylesheet names were case insensitive.

Runtime:

  * Implemented a DrScheme IDE plugin with fairly good support for the
    5L language.  We may need to tweak this slightly later on.
  * Fixed the 5L-Loader and 5L-tool to initialize namespaces in the same way.
  * Implemented and documented lots of nice, high-level wrappers around
    the most error-prone of the low-level primitives.
  * Implemented DEFINE-STYLESHEET, which allows an author to declare
    headers and stylesheets at the same time, and to base them off earlier
    stylesheets.
  * Merged in Brian's WITH-TRACING macro.
  * Merged in Brian's support for variable interpolation.

3.5.3 - 18 Aug 2002 - emk

Changes to support the rapidly-growing test suites.

Engine:

  * Renamed _error variable to _errorcode to avoid conflicting with the
    _error variable used by the 'video' command (which we'll probably
    need to clean up sometime, but that's life).  This will affect
    scripts which call the BROWSE command, but not much else.

Runtime:

  * Implemented DEFINE-ENGINE-VARIABLE, which provides transparent
    binding between Scheme and 5L variables.
  * Added *TEXT-X*, *TEXT-Y*, *GRAPHIC-X* and *GRAPHIC-Y* variables,
    which are bound to _INCR_X, INCR_Y, _Graphic_X and _Graphic_Y.
  * Added WHILE and FOR-EACH-ITEM loops.
  * Added HAVE-5L-PRIM? and REFRESH functions.
  * Modified JUMP function to use JUMP primitive when available, so video
    gets killed when jumping between cards.
  * Refresh the screen at the end of each card.

3.5.2 - 18 Aug 2002 - emk

  * Modified the TSchemeInterpreter class to make intelligent use of
    namespaces and modules.
  * Fully modularized the runtime, and made the lispish language extensions
    available.  The "lispish" code currently belongs to me (and is released
    under the LGPL), but I'll be happy to relicense it to the Trustees.
  * Got redoscript to work--we no longer attempt to restart the entire
    Scheme interpreter; we merely throw away a sandbox.
  * Moved the code for resetting stylesheets out of the TWin5LInterpreter
    and into the main Win32 engine.

3.5.1 - 16 Aug 2002 - emk

Added support for defining stylesheets in Scheme.  This means that Scheme
can draw text!  (The INPUT doesn't work yet, because this relies on the
separate, not-yet-fixed header system.)  This involved lots of refactoring.

  * Created TTopLevelFormProcessor as an abstract superclass of
    TIndexManager, and modified TParser to use TTopLevelFormProcessor.
    This allows the legacy 5L language to contain non-TIndex tlfs.
  * Implemented a TPrimitiveTlfProcessor class, which allows
    top-level-forms to be implemented as calls to regular 5L primitives.
  * Yanked our ValueOrPercent support from TStream into the
    TArgumentList superclass, and implemented it for all TArgumentList
    subclasses.  This allows non-5L languages to specify the funky 
    percentage arguments used by the DEFSTYLE command.
  * Removed all TIndex/TIndexManager support from TStyleSheet, and
    reimplemented it using an STL std::map.  This breaks the dependencies
    between stylesheets and the old 5L interpreter.
  * Implemented a DEFSTYLE primitive.

3.5.0 - 16 Aug 2002 - emk, zeb

Preliminary Scheme support for Windows.  The Macintosh build is broken
until Brian updates the event loop to use a TInterpreterManager object
and figures out how to get the mzscheme libraries building.

  * Imported Boost library (from http://www.boost.org/) into CVS.
  * zeb: Moved some primitives from TMacPrimitives.cpp and TWinPrimitives.cpp
    to TCommonPrimitives.cpp and T5LPrimitives.cpp.
  * zeb: Added a GET primitive.
  * zeb: Cleaned date stuff out of LUtil.{h,cpp}.
  * First work on Scheme.
  * Overhaul of the Windows event handling system.
  * The interpreter now calls the idle loop, instead of vice versa.
  * Redoscript is now handled by a TInterpreterManager object.
  * It's no longer possible to switch between scripts.
  * Updated TSchemeInterpreter to use new event loop system.
  * Filled in lots of missing Scheme support.
  * Converted kernel.ss to use an internal state machine.
  * Implemented various timer systems.
  * Preliminary Windows integration.
  * Fixed nasty "Minimize when backgrounded" behavior when running in
    windowed mode (this was driving me crazy while debugging).
  * Ported 3.4.1 changes to the development branch.

3.4.2 - 28 Sep 2002 - emk

  * Fixed bug where cursor was visible during movie playback.  This bug
    was introduced when the movie controller patches were added.

3.4.1 - 14 Aug 2002 - emk

Language bugfixes/enhancements/changes for HIV Prevention Counseling.  I
removed some deeply-buried bugs in TStream and elsewhere, so please test
this build thoroughly.

  * New entities: &shy;, &nbsp;, and &radic;.  I've also added
    &check; and &cross;, but we don't have the necessary font support yet.
  * TStream now handles whitespace rationally.  String literals are
    parsed verbatim, and the old "randomly munge whitespace" behavior
    has been fixed.  Most of the other changes are necessary consequences
    of this change.
  * Verbatim CR, LF and TAB characters in strings will be passed through.
    This may affect screen layout.
  * The (get ...) primitive has been backported from 3.5.
  * The '&' syntax has been removed.  Instead of '&foo$bar', you should
    now write '$(get foo$bar)'.
  * Entities don't need to be escaped any more: \&amp; -> &amp;.

Thanks to this cleanup, it was possible to implement several much-wanted
features without too much work:

  * New primitives: WHEN, UNLESS and WHILE.
  * BODY has been renamed to BEGIN, and longer prematurely evaluates all
    the variables in nested expressions.
  * Debug log improvements.

3.4.0 - 26 July 2002 - emk

  * Updated version numbers for official stable release!
  * Macintosh compilation fix in FileSystem.cpp.

3.3.21 - 26 July 2002 - zeb

  * Added FileSystem::ExistenceCheck, which we use to check for the
    existence of various files during the startup process (bug #937).

3.3.20 - 26 July 2002 - emk

A QA binge, thanks to RedHat's memprof, Bruce Perens' Electric Fence,
and Rational's Purify.

  * Linux build fixes so I can run memprof and Electric Fence.
  * Fixed a bug in TStream::GetStringArg when called on an empty stream.
    This is probably why we were seeing weird results when CHeader called
    TStream::more() too many times.
  * Fixed a buffer-overflow bug in TLogger when logging large messages.
  * Squashed a bunch of memory leaks in CryptStream.cpp.
  * Made new CryptStream auto_ptr code work under Windows.
  * PURIFY: Fixed memory leak in TBTree::Add of duplicate node.  We now
    notify the user if there are duplicate cards, macros, etc.
  * PURIFY: Fixed memory leak in TBTree destructor.
  * PURIFY: Fixed memory leak in ConfigManager destructor.
  * PURIFY: Fixed memory leaks when deleting DIBs.
  * PURIFY: Made sure we deleted offscreen GWorld when exiting.
  * PURIFY: Fixed memory leak in LBrowser.
  * PURIFY: Fixed memory leak in LFileBundle.
  * PURIFY: Fixed uninitialized memory reads when View methods were
    called before View::Init.
  * PURIFY: Made View::Draw a no-op before View::Init is called.
    (It seems that Windows causes us to call Draw too early.)
  * Added TOUCHCOUNT, TOUCHCOORDS and TOUCHACTIVATE commands so Douglas
    can build an automatic test monkey.  These are Win32-only, because
    the Mac touchzone system needs an overhaul and I don't want to
    mess with it right now (bug #1076).
  * Added StValueRestorer<> template class which can save and restore
    the values of variables in an exception-safe fashion.
  * Began code audit for exception safety (bug #1074).

3.3.19 - 24 July 2002 - emk

  * Cleaned up Win32 5L.log (bug #1057).
  * We now print the glyph cache size every 100K (bug #969).

3.3.18 - 23 July 2002 - emk

  * Forward-ported QtComponentVersion to the Mac (bug #1054).
  * Fixed redoscript/keybind race condition (bug #1036).
  * Added a top-level try/catch block on the Mac (bug #955).
  * Added error checking in Mac BROWSE (bug #1070).
  * Enlarged our growzone a bit, and made sure it's working.  This will
    help us determine if we have memory usage problems (bug #969).

3.3.17 - 23 July 2002 - emk

  * Fixed RETURN in macros (bug #1053).
  * Fixed typography exception when missing buttpcx graphic (bug #1039).
  * Made Win32 BROWSE return an error if it fails (bug #793).
  * Forward-ported QtComponentVersion to Win32 (bug #1054).
  * Performance tuned Win32 textaa (bug #933).
  * Added lots of try/catch wrappers on Win32 (bug #955).

3.3.16 - 19 July 2002 - emk

  * Fixed "b" parameter to defstyle (bug #1052).
  * Fixed Mac/Win32 engine to log missing macros to Debug.log (bug #1060).
  * Fixed Windows macro recursion (bug #1053).
  * Fixed debug-log discrepencies (bug #1064).
  * Fixed logging of Windows macro arguments (bug #1065).

3.3.15 - 17 July 2002 - brian

  * Fixed excessive error messages for missing button graphics (#1039).
  * This bug might still occur on Windows; it needs to be looked into.

3.3.14 - 15 July 2002 - brian, emk

  * Fixed GWorld flashing (bug #930).
  * Windows 3.3.13 fixes ported to the Macintosh.

3.3.13 - 15 July 2002 - zeb, emk

  * Language change: (IF cond true_cmd false_cmd) now takes arbitrary
    expressions for 'cond'.  The following new primitives have
    been added: AND, OR, NOT, contains, =, <>, <, >, <=, >=.
  * Added a new (LOG filename msg) command, which allows the programmer
    to write to "5L", "debug" and "MissingMedia" logs.
  * Major logging improvements: All primitives are now automatically
    logged in a standard format (bug #1003).
  * Adjusting of coordinates using origin is now logged.
  * Callbacks are now logged in a much more useful fashion.
  * Old arithmetic primitives now return a value (add, sub, div).
  * Added MakeQuotedString to TTemplateUtils and wrote a matching test suite.

3.3.12 - 10 July 2002 - brian

  * Made textAA and text log coordinates of bounding box (bug #979).

3.3.11 - 7 July 2002 - emk

Ported forward 3.2.0.x fixes (bug #1008).

  * Ported Win32 QuickTime 6/VP3 bugfix forward from 3.2.0.x.
  * Ported Win32 QuickTime 6 gamma bugfix forward from 3.2.0.x.
  * Ported Mac QuickTime 6 gamma bugfix forward from 3.2.0.x.
  * Ported Win32 line drawing bugfix forward from 3.2.0.x.
  * Fixed Win32 (touch ...) command to highlight touchzones more like the
    Macintosh.  (It now redraws the unhighlighted graphic at the end of the
    highlight sequence.)

3.3.10 - 7 July 2002 - zeb

  * Added a new Release-Notes.txt file.
  * Fixed a bug which caused LFileBundle to die with an assertion
    failure when importing an empty file.
  * New feature: Modulo primitive.  5L now supports Modulo(x,y).
    Syntax is (% x y).

OLDER LOGS, RECOVERED FROM CVS
------------------------------

3.3.9 - emk

  Highly experimental engine which makes _INCR_X, _INCR_Y, _Graphic_X and
   _Graphic_Y relative to the current origin.  This will break macros in
   existing code!

3.3.8 - emk

  5L language improvements, including nested expressions, return values and
  new primitives.

   * Expressions can now be nested: '(set x $(+ 2 $(* 3 5)))' will
     set 'x' to 17.  Nested expressions should be indented as follows:

       (set x $(+ $really_big_variable_1
                  $really_big_variable_2))

     ...that is, arguments should _stack in a column_.  I will be
     extremely anal about this if I'm reading your code.

   * '(return ...)' now takes an optional argument, which will be
     returned from the macro.  So you can define your own functions, too.

   * New primitives: +, -, *, /, truncate, float+, float-, float*,
     float/, strlen, substr, findsubstr, length, nth, haskey, getval.

  A note on Lisp naming conventions--when you create a new "data structure"
  type, you should generally name functions as follows:

   # Define a type 'pt' with members 'x' and 'y' using lists.
   (macrodef pt (return ($1 $2)))
   (macrodef pt-x (return $(nth 0 $1)))
   (macrodef pt-y (return $(nth 1 $1)))

   # Alternative implementation of a type 'pt2' using associative lists.
   # (You couldn't pass 'pt2' to a built-in command, but it's a nice small
   # example.)
   (macrodef pt2 (return (x $1 y $2)))      # (pt2 10 20) => (x 10 y 20)
   (macrodef pt2-x (return $(getval $1 x))) # (pt2-x ...) => 10
   (macrodef pt2-y (return $(getval $1 y))) # (pt2-y ...) => 20

  The function 'pt' is called the "constructor", and the functions 'pt-x'
  and 'pt-y' are called "accessors".

3.3.7 - emk

  Debug log updates, and error message if 5L is run without
  Mac5L.config or other support files.

3.3.6 - emk

  Fixed problems with BUTTPCX (and other?) highlighting.

3.3.5 - emk

  Merged the 'FiveL_3_3_4_refactor_lang_1' branch back into the trunk.
  This branch contained the following enhancements:

   * Most of the communication between the interpreter and the
     engine now goes through the interfaces defined in
     TInterpreter.h and TPrimitive.h.  Among other things, this
     refactoring makes will make it easier to (1) change the interpreter
     from 5L to Scheme and (2) add portable primitives that work
     the same on both platforms.
   * A new system for handling callbacks.

  I also slipped in the following, unrelated enhancements:

   * MacOS X fixes.  Classic Mac5L once again runs under OS X, and
     there is a new, not-yet-ready-for-prime-time Carbonized build.
   * Bug fixes from the "Fix for 3.4" list.

3.3.4.12 - emk

  Last build of the 'FiveL_3_3_4_refactor_lang_1' branch
  before merging.

3.3.4.11 - emk

  Refactored Mac code to move primitives from CCard.{h,cpp} to
  TMacPrimitives.{h,cpp}, and break most of the remaining dependencies on
  the 5L interpreter.

  Language changes: LOADPICK, RVAR and RNODE are gone.  I've also disabled
  the Mac PAUSE command until Douglas tells me how it should work.

  Testing: Please beat *very* hard on this build, and pay special attention
  to WAIT, NAP, TIMEOUT, and similar commands.

  Next up: I plan to merge this branch into HEAD tomorrow.

3.3.4.10 - emk

  Debug log message improvements on the Mac.

3.3.4.9 - emk

  Fixed _Origin_X, _Origin_Y on Windows, and added a "default style"
  parameter to "defstyle" on both platforms.

  The new syntax:

   (defstyle sample (Nimbus Roman No9 L) 12 r left 0xF0F0F000 0xFFFF0000)

   ...where r = "regular", b = "bold", i = "italic" and bi = "bold italic".

3.3.4.8 - emk

  Added (BODY ...) command on Mac, fixed arguments of BUTTPCX, TOUCH,
  and KEYBIND to match Win32 engine, and refactored Mac engine to more-or-less
  respect the TInterpreter interface.

  Things to test: REDOSCRIPT, redo-REDOSCRIPT (feed REDOSCRIPT a bogus script,
  try to fix it, then run REDOSCRIPT again), TOUCH, BUTTPCX, ORIGIN.

  Some low-level details:

   - Added a KillCurrentCard method to the TInterpreter interface.  This
     works a lot like Pause, but it cannot be resumed.
   - Added a rough-cut TMac5LInterpreter class (with some methods stubbed
     out, because they are not needed on the Mac--we should look at
     this API in detail and formalize it sometime after 3.4).
   - Modified CTouchZone to take TCallback objects.
   - Modified CPlayerView's keybinding support to take TCallback objects
     (and to use a std::map instead of a PowerPlant list class).
   - Began to separate special forms (IF, BODY, EXIT, RETURN) from other
     commands.
   - Moved ReadSpecialVariable_* methods out of CCard and into CMac5LApp.
   - Made sure CMac5LApp::mReDoReDo got initialized to false.
   - Merged OpenScript and OpenScriptAgain into one function.

3.3.4.7 - emk

  Carbonization of Mac build, support for running non-Carbonized build
  in MacOS X's OS 9 emulator, and basic support for 5L.prefs on the Mac.  The
  Carbon build isn't yet ready for prime time--see BugHunt for details--but it
  is good enough to use for engine development.

  * Language changes

   - CHECKDISC is gone; use CHECKVOL instead.
   - EJECT is disabled in the Carbon build, because Carbon has no way to
     identify CD drives reliably.  EJECT still works in the regular build.
   - Gamma fades are ignored in the Carbon build.
   - KEYBINDs must now be accessed with the Command key only--not Option.

  * Things to test

  Please be hugely brutal to 5L; this is a big update.

   - 8-bit systems, palettes, ORIGIN, EJECT on the non-Carbon build.

  * Internal changes

   - TException class (and all subclasses) now take a __FILE__ and __LINE__
     parameter.  This is ugly, but it allows me to debug 5L exceptions even
     without a working debugger (under the OS 9 emulator, for example).
   - FileSystem::Path::(DoesExist|IsRegularFile|IsDirectory) now rely on
     native MacOS File Manager calls instead of the broken MSL stat()
     function (which fails in the OS 9 emulator).
   - The ImlUnit test harness flushes its output more often.
   - Many data structure accessors (and such functions as c2pstr) have been
     replaced by their Carbon equivalents.
   - We now use PowerPlant accessors to get at the QuickDraw globals.
   - We now use PowerPlant calls in place of ValidRect and InvalRect.
   - Some very nasty code which set the palettes of our offscreen GWorlds
     has been removed (offscreen GWorlds have CLUTs, not palettes!).
     The various drawing commands now use gPaletteManager to map indexes
     to RGBColor values, and RGBForeColor to set the color--no more calls
     to ::PmForeColor on offscreen GWorlds, thank you!
   - The CMenuUtil code (which used low-memory system globals to hide
     and show the menu bar) has been removed entirely and replaced by
     calls to HideMenuBar and ShowMenuBar (which are present in 8.5 and
     Carbon).  This is much simpler, nicer, more portable and safer.
   - A bunch of code which had been disabled with #ifdefs has been
     removed entirely.  This mostly related to palettes and an obsolete
     version of the fade code which used GWorlds.
   - Code which used ROM-based KCHR resources to map option keys back to
     their unmodified key caps has been removed.  This means KEYBINDs
     can only be accessed using the Command key.
   - We assume Carbon systems always support the HFS file system (duh).
   - We use PowerPlant glue to access either StandardFile or Navigation
     Services, under OS 8/9 and Carbon, respectively.
   - Some old subroutines in CModuleManager appeared to have been
     snarfed from More Files, an old Mac utility library.  These have
     been moved into MoreFiles.{h,cpp}.

  * Known Carbon Problems

  Fades, ejecting CD-ROMs and playing QuickTime movies are all broken in
  the Carbon build.  Douglas has found a problem with ORIGIN.  It looks
  like we should continue to ship the OS 9 build for use with MacOS X,
  at least for next few months.

3.3.4.6 - 2002/06/12 19:42:36 - emk

  Fixed bug where the origin didn't get restored after each macro
  call.  (This bug was introduced in 3.3.4.5.)

3.3.4.5 - 2002/06/12 19:02:51 - emk 

  Moved Do* commands from Card.{h,cpp} to TWinPrimitives.{h,cpp},
  and broke the remaining dependencies between these primitive commands and
  the current 5L interpreter.  The TInterpreter and TPrimitives interfaces
  are now quite mature.

  *** Please beat very, very hard on this build.  I don't anticipate
  further changes to the Windows engine for a while. ***

  REMOVED COMMANDS: kill (use still), loadpick (use loadpic)
  NEEDS TESTING: origin w/macros, other uses of origin.  5L now
   sets the origin to 0,0 whenever it begins a new card, which
   should produce behavior identical to the old system, unless
   I've overlooked something.
  NEEDS TESTING: make sure all the commands are available, and
   have the right names.  I've checked this a dozen times
   by eye, but I might have overlooked something.

  The only remaining dependencies between the interpreter and the rest of
  5L are in the Header and TStyleSheet classes.  I'm postponing this last
  bit of cleanup until after 3.4.  Up next: Repeat the 3.3.4.{1-5} changes
  for the Macintosh.
 
3.3.4.4 - 2002/06/11 18:15:31 - emk

  Partial separation of primitives from interpreter, and
  various 5L language enhancements related to callbacks.

   - Finished fleshing out TArgumentList, added support for callbacks.
   - Made all built-in primitives access their arguments through the
     TArgument interface.
   - Implemented a BODY command.
   - Changed how the TOUCH, BUTTPCX and KEYBIND commands parse their
     callback arguments.  See below for details; you'll have to change
     some code.  This was necessary to move callback parsing into
     TStream's implementation of the TArgumentList interface.

  5L Language Changes
  -------------------

   * (KEYBIND ...) now takes an arbitrary command instead of a card name.
     As with TOUCH and BUTTPCX, variables are evaluated when the
     keybind is installed, not when it is invoked.  Examples:

       (keybind f (jump foo))
       (keybind a (add x 10))

   * You can now run a series of zero or more commands using (BODY cmd...).
     This should work with IF, TOUCH, BUTTPCX and KEYBIND.  Example:

       (body
         (set x 10)
         (set y 20))

     Commands such as WAIT, JUMP, NAP, etc., will not do what you expect
     unless they're the last statement in a BODY.  This is caused by the
     low-level design of the interpreter, and is non-trivial to fix.

     RETURN is also not BODY-friendly.

     When you pass a body to IF, TOUCH, BUTTPCX or KEYBIND, all the
     variables in the body will be evaluated *before* any code is run!

   * The arguments to BUTTPCX and TOUCH have been rationalized after
     consultation with Douglas.  The commands now work as follows:

       (TOUCH rect cmd [cursor [picture [point]]])
       (BUTTPCX picture point header label cmd [cursor])

     Note that the second callback has disappeared from both TOUCH and
     BUTTPCX; use BODY instead.

3.3.4.3 - 2002/06/10 17:52:48 - emk

  Added a TArgumentList class in TPrimitives.  This class provides
  an abstract interface to argument list parsing, and replaces parts of
  TStream.  This will allow us to begin breaking dependencies between
  the primitives and the nasty parsing gunk in TStream.

3.3.4.2 - 2002/06/05 20:42:29 - emk

  Broke Win5L dependencies on TIndex file by moving various pieces
  of code into TWin5LInterpreter.  Windows 5L now accesses the interpreter
  through a well-defined API.  Changes:

   * Removed many direct and indirect #includes of TIndex.h.
   * Added a TInterpreter method ReloadScript, which can be called by the
     higher-level ReDoScript command.
   * Checked in some files which should have been included in the 3.3.4.1
     checkin--these files contain the initial refactorings of Card and Macro
     callsites to go through the TInterpreter interface.

  Up next: Refactor various Do* methods out of Card and into a procedural
  database.

3.3.4 - 2002/05/29 13:58:10 - emk

  Fixed various crash-on-exit problems (including those in TBTree,
  TIndex and TLogger::FatalError), and reverted the Win32 _INCR_Y code
  to the behavior that shipped with Genetics.

3.3.3 - 2002/05/15 11:05:18 - emk

  Merged in changes from FiveL_3_3_2_emk_typography_merge branch.
  Synopsis: The Common code is now up to 20Kloc, anti-aliased typography is
  available, and several subsystems have been refactored.  For more
  detailed descriptions, see the CVS branch.

  The merged Mac code hasn't been built yet; I'll take care of that next.

  Added support for passing a "(pcent ...)" argument to "defstyle" to
  specify leading as a percentage of the base font size (and cleaned up a
  few minor test suite issues).

3.3.2.7 - 2002/05/01 07:10:49 - emk

  Fixed assertion failure on "Special Variables" screen, fixed
  missing bullets, and added "\&Delta;" and "\&delta;" entities for
  use with the (textaa ...) command only.

3.3.2.6 - 2002/05/01 03:27:02 - emk

  First Windows engine with (textaa ...) command.

   - Implemented a primitive, slow Image::DrawPixMap command that uses
     ::GetPixel and ::SetPixel to do alpha blending (shudder).  Strangely
     enough, it's about as fast as the somewhat optimized Mac routines.
     Anyone got a good GDI book?

   - Fixed several assertion failures.

  Known problems:

   - Occasional assertion failure on exit.  The reference-counting on
     TIndexFile claims it's getting dereferenced too many times.  This is
     an old bug; all the TBTree and TBNode classes are pretty dodgy.

   - Assertion failure on "Special Variables" screen in 5Ltest.  This is
     caused by overlong lines.

3.3.2.5 - 2002/04/30 07:57:24 - emk

  Port Win32 code to use the 20Kloc of Common code that now
  exists.  The (defstyle ...) command should work, but (textaa ...) isn't
  available yet.

  Next up: Implement the (textaa ...) command and the low-level
  GraphicsTools::Image::DrawBitMap.

3.3.2.4 - 2002/04/29 06:29:58 - emk

  Contains first set of performance tweaks, and fixes problem with
  assertion failures after reload and on CME screens.

3.3.2.3 - 2002/04/26 11:31:01 - emk

  Fixed highlight shadow color to default to regular shadow color (instead
  of highlight color, which is obviously wrong).

3.3.2.2 - 2002/04/26 08:51:21 - emk

  First experimental engine with (textaa ...) and (defstyle ...) commands.

  Changes:

   - Ported new TEncoding template class to the Mac.

   - Updated TStyleSheet to provide bug-for-bug compatibility with the way
     backslashed escaped sequences are processed.

??? - 2002/04/23 11:29:47 - emk

  Prepended "VERSION_" to the version-related preprocessor defines, because
  this way is (1) nicer and (2) matches the Mac engine's preprocessor
  defines.

??? - 2002/04/19 11:20:13 - emk

  Start of the heavy typography merging work.  I'm doing this on a branch
  so I don't cause problems for any of the other developers.

  Alpha-blend text colors.

  Merged Mac and Windows versions of several files into the Common directory.
  Not all of these work on Mac and/or Windows yet, but they're getting there.
  Primary sources for the merged code are:

   Win/FiveL/LVersion.h -> Common/TVersion.h
   Win/FiveL/LStream.h -> Common/TStream.h
   Mac/Source/CStream.cp -> Common/TStream.cpp
   Mac/Source/CStreamTests.cp -> Common/TStreamTests.cpp

  TStream changes:

   * The TStream code now uses a callback to variable values.  This will
     probably go away once Variable and CVariable get merged.
   * Input operators for std::string and GraphicTools::Color.

  Isolated Windows-specific code in TLogger.*, in preparation for a big merge.

   * Added a portable function to set up logging.
   * Fixed the logging code to use the portable FileSystem library.
   * Made FatalError actually quit the application.

  Turned off the FiveL namespace on FIVEL_PLATFORM_OTHER, so we can debug
  with GDB, which has a few minor but painful namespace issues.

  TString changes:

   * Made sure we can convert from std::string to a TString.
   * Added some more assertions.
   * Fixed bug in various operator= methods which would allow the string's
     internal data pointer to be NULL.
   * Changed operator[] and operator() arguments to be 'int' instead of
     'int32' to avoid nasty compiler warnings.

  Typography::Style changes:

   * Added a "ShadowOffset" field that specifies the offset of the
     drop shadow.
   * Added an operator== for testing.
   * Added a ToggleFaceStyle method for toggling specified face style bits.

  Typography::StyledText changes:

   * Added a method to append a single character.

  Other Typography changes:

   * Made FaceStyle an int, not an enum, so we can do bit math with it.
   * Added assertions to made sure you can't extract a StyledText iterator
     until you've called EndConstruction.

??? - 2002/04/19 10:21:52 - hyjin

  Added support for a movie controller in 5L applications, and deleted some
  buggy pre-roll code that appeared to be causing crashes.  We're not a
  hundred percent sure all the crashing problems are fixed, but things seem
  to be working very well.  Please test this extensively!

  Set global variable _bShowMC to see the movie controller (case insensitive).

  Changes by Yijin, reviewed by Eric Kidd.

EARLIER REVISIONS
-----------------

  Lots of work to create a Common/ directory from the platform-specific
  directories, followed by work to create a portable Typography and
  GraphicsTools library.

  For even earlier work, look at the ReleaseNotes.txt files in
  Mac/ and Win32/, which contain the history of the old, platform-specific
  engines before the merge.
